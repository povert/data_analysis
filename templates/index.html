{% extends "base.html" %}

{% block title %}项目列表 - 数据文件管理系统{% endblock %}

{% block content %}
<div class="row mb-4">
    <div class="col-md-8">
        <h1><i class="fas fa-list"></i> 数据项目列表</h1>
    </div>
    <div class="col-md-4">
        <div class="input-group">
            <input type="text" id="searchInput" class="form-control" placeholder="搜索项目...">
            <button class="btn btn-outline-secondary" type="button" id="searchBtn">
                <i class="fas fa-search"></i>
            </button>
        </div>
    </div>
</div>

<div class="row" id="projectsContainer">
    {% for project in projects %}
    <div class="col-md-6 col-lg-4 mb-4 project-card" 
         data-filename="{{ project.filename|lower }}" 
         data-description="{{ project.description|lower }}">
        <div class="card h-100">
            <div class="card-body d-flex flex-column">
                <h5 class="card-title">
                    <i class="fas fa-file-alt"></i> {{ project.filename }}
                </h5>
                <p class="card-text">{{ project.description }}</p>
                <div class="mt-auto">
                    <div class="d-flex justify-content-between align-items-center mb-2">
                        <span class="badge bg-primary">{{ project.file_type.upper() }}</span>
                        <small class="text-muted">{{ project.record_count }} 条记录</small>
                    </div>
                    <div class="d-flex gap-2">
                        <a href="/project/{{ project.id }}" class="btn btn-primary flex-grow-1" style="flex-basis: 66.666%;">
                            <i class="fas fa-eye"></i> 查看详情
                        </a>
                        <button class="btn btn-danger delete-project" data-project-id="{{ project.id }}" style="flex-basis: 33.333%;">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
    {% endfor %}
</div>

{% if not projects %}
<div class="text-center py-5">
    <i class="fas fa-inbox fa-3x text-muted mb-3"></i>
    <h3 class="text-muted">暂无数据项目</h3>
    <p class="text-muted">
        <a href="/upload" class="btn btn-primary">
            <i class="fas fa-upload"></i> 上传第一个数据文件
        </a>
    </p>
</div>
{% endif %}
{% endblock %}

{% block scripts %}
<script>
$(document).ready(function() {
    // 搜索功能
    $('#searchInput, #searchBtn').on('input click', function() {
        const searchTerm = $('#searchInput').val().toLowerCase();
        
        $('.project-card').each(function() {
            const filename = $(this).data('filename');
            const description = $(this).data('description');
            
            if (filename.includes(searchTerm) || description.includes(searchTerm)) {
                $(this).show();
            } else {
                $(this).hide();
            }
        });
    });
    
    // 删除项目功能
    $('.delete-project').on('click', function() {
        const projectId = $(this).data('project-id');
        const projectCard = $(this).closest('.project-card');
        const projectName = projectCard.find('.card-title').text();
        
        if (confirm(`确定要删除项目 "${projectName}" 吗？此操作不可撤销！`)) {
            deleteProject(projectId, projectCard);
        }
    });
    
    function deleteProject(projectId, projectCard) {
        $.ajax({
            url: `/api/project/${projectId}`,
            method: 'DELETE',
            success: function(response) {
                // 添加淡出动画
                projectCard.fadeOut(500, function() {
                    $(this).remove();
                    
                    // 检查是否还有项目
                    if ($('#projectsContainer .project-card').length === 0) {
                        location.reload(); // 重新加载页面显示空状态
                    }
                });
                
                // 显示成功提示
                showNotification('项目删除成功', 'success');
            },
            error: function(xhr) {
                const errorMsg = xhr.responseJSON ? xhr.responseJSON.detail : '删除失败';
                showNotification(`删除失败: ${errorMsg}`, 'danger');
            }
        });
    }
    
    function showNotification(message, type) {
        const notification = $(`
            <div class="alert alert-${type} alert-dismissible fade show position-fixed" 
                 style="top: 20px; right: 20px; z-index: 1050; min-width: 300px;">
                ${message}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            </div>
        `);
        
        $('body').append(notification);
        
        // 3秒后自动消失
        setTimeout(function() {
            notification.fadeOut(500, function() {
                $(this).remove();
            });
        }, 3000);
    }
});
</script>
{% endblock %}