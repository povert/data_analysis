{% extends "base.html" %}

{% block title %}{{ project.filename }} - 数据详情{% endblock %}

{% block content %}
<div class="row mb-4">
    <div class="col-md-12">
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h3><i class="fas fa-table"></i> {{ project.filename }}</h3>
                <a href="/" class="btn btn-secondary">
                    <i class="fas fa-arrow-left"></i> 返回列表
                </a>
            </div>
            <div class="card-body">
                <p class="mb-2"><strong>描述：</strong> {{ project.description }}</p>
                <div class="row">
                    <div class="col-md-3">
                        <span class="badge bg-primary">{{ project.file_type.upper() }}</span>
                    </div>
                    <div class="col-md-3">
                        <small class="text-muted">记录数：{{ project.record_count }}</small>
                    </div>
                    <div class="col-md-6 text-end">
                        <small class="text-muted">创建时间：{{ project.created_at }}</small>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="row mb-3">
    <div class="col-md-8">
        <div class="d-flex align-items-center">
            <label class="me-2">显示字段：</label>
            <button id="fieldSelectorBtn" class="btn btn-sm btn-outline-primary" data-bs-toggle="modal" 
                    data-bs-target="#fieldModal">
                <i class="fas fa-list"></i> 选择字段
            </button>
            <span id="selectedFieldsCount" class="badge bg-secondary ms-2">全部字段</span>
        </div>
    </div>
    <div class="col-md-4 text-end">
        <div class="d-inline-flex align-items-center">
            <label class="me-2">每页显示：</label>
            <select id="perPageSelect" class="form-select form-select-sm" style="width: auto;">
                <option value="25">25</option>
                <option value="50" selected>50</option>
                <option value="100">100</option>
            </select>
        </div>
    </div>
</div>

<!-- 字段选择模态框 -->
<div class="modal fade" id="fieldModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">选择显示字段</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="mb-3">
                    <button id="selectAllFields" class="btn btn-sm btn-outline-primary">全选</button>
                    <button id="deselectAllFields" class="btn btn-sm btn-outline-secondary ms-2">全不选</button>
                </div>
                <div class="row" id="fieldCheckboxes">
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                <button type="button" class="btn btn-primary" id="applyFieldsBtn">应用</button>
            </div>
        </div>
    </div>
</div>

<div class="card">
    <div class="card-body">
        <div class="table-responsive">
            <table class="table table-striped table-hover" id="dataTable">
                <thead class="table-dark">
                    <tr id="tableHeader">
                        <th>序号</th>
                    </tr>
                </thead>
                <tbody id="tableBody">
                </tbody>
            </table>
        </div>
        
        <nav aria-label="数据分页">
            <ul class="pagination justify-content-center" id="pagination">
            </ul>
        </nav>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
// HTML转义函数
function escapeHtml(text) {
    if (typeof text !== 'string') {
        return text;
    }
    const map = {
        '&': '&amp;',
        '<': '&lt;',
        '>': '&gt;',
        '"': '&quot;',
        "'": '&#039;'
    };
    return text.replace(/[&<>"']/g, function(m) { return map[m]; });
}

// HTML反转义函数
function unEscapeHtml(text) {
    if (typeof text !== 'string') {
        return text;
    }
    const map = {
        '&amp;': '&',
        '&lt;': '<',
        '&gt;': '>',
        '&quot;': '"',
        '&#039;': "'",
        '&apos;': "'"
    };
    return text.replace(/&(amp|lt|gt|quot|#039|apos);/g, function(m) { return map[m]; });
}

// 安全的HTML sanitizer，只允许安全的HTML标签
function sanitizeHtml(html) {
    // 检查内容是否包含HTML标签
    if (!html || typeof html !== 'string' || !html.includes('<') || !html.includes('>')) {
        return html;
    }
    
    // 使用DOMParser来解析HTML，确保安全性
    const parser = new DOMParser();
    const doc = parser.parseFromString(html, 'text/html');
    
    // 只允许安全的标签
    const allowedTags = ['b', 'i', 'em', 'strong', 'p', 'br', 'h1', 'h2', 'h3', 'h4', 'h5', 'h6', 'ul', 'ol', 'li', 'span', 'div', 'small', 'code', 'pre'];
    
    // 递归处理DOM节点，移除不安全的标签
    function sanitizeNode(node) {
        if (node.nodeType === Node.TEXT_NODE) {
            return document.createTextNode(node.textContent);
        } else if (node.nodeType === Node.ELEMENT_NODE) {
            if (allowedTags.includes(node.tagName.toLowerCase())) {
                const newNode = document.createElement(node.tagName);
                // 只允许安全的属性
                for (let attr of node.attributes) {
                    if (['class', 'style', 'id'].includes(attr.name.toLowerCase())) {
                        // 确保style属性不包含危险内容
                        if (attr.name.toLowerCase() === 'style') {
                            const styleValue = attr.value.toLowerCase();
                            if (!['javascript:', 'vbscript:', 'script:', 'url('].some(x => styleValue.includes(x))) {
                                newNode.setAttribute(attr.name, attr.value);
                            }
                        } else {
                            newNode.setAttribute(attr.name, attr.value);
                        }
                    }
                }
                for (let child of node.childNodes) {
                    newNode.appendChild(sanitizeNode(child));
                }
                return newNode;
            } else {
                // 如果标签不安全，则提取其内容
                const fragment = document.createDocumentFragment();
                for (let child of node.childNodes) {
                    fragment.appendChild(sanitizeNode(child));
                }
                return fragment;
            }
        }
        return document.createDocumentFragment();
    }
    
    // 处理文档的所有子节点
    const sanitized = document.createDocumentFragment();
    for (let child of doc.body.childNodes) {
        sanitized.appendChild(sanitizeNode(child));
    }
    
    // 创建一个临时容器来获取HTML字符串
    const tempDiv = document.createElement('div');
    tempDiv.appendChild(sanitized);
    return tempDiv.innerHTML;
}

const projectId = '{{ project.id }}';
let allColumns = {{ project_data.columns|tojson }};
let currentColumns = [...allColumns];
let currentPage = 1;
let perPage = 50;
let filters = {};

$(document).ready(function() {
    initializeFieldSelector();
    loadData();
    
    // 应用字段选择
    $('#applyFieldsBtn').on('click', function() {
        const selectedFields = [];
        $('#fieldCheckboxes input:checked').each(function() {
            selectedFields.push($(this).val());
        });
        
        currentColumns = selectedFields.length > 0 ? selectedFields : allColumns;
        updateSelectedFieldsCount();
        currentPage = 1;
        loadData();
        
        // 关闭模态框
        $('#fieldModal').modal('hide');
    });
    
    // 全选字段
    $('#selectAllFields').on('click', function() {
        $('#fieldCheckboxes input').prop('checked', true);
    });
    
    // 全不选字段
    $('#deselectAllFields').on('click', function() {
        $('#fieldCheckboxes input').prop('checked', false);
    });
    
    // 每页显示数量变化
    $('#perPageSelect').on('change', function() {
        perPage = parseInt($(this).val());
        currentPage = 1;
        loadData();
    });
});

function initializeFieldSelector() {
    const container = $('#fieldCheckboxes');
    container.empty();
    
    allColumns.forEach(column => {
        const colDiv = $('<div class="col-md-4 mb-2"></div>');
        colDiv.append(`
            <div class="form-check">
                <input class="form-check-input" type="checkbox" value="${column}" 
                       id="field_${column}" checked>
                <label class="form-check-label" for="field_${column}">
                    ${column}
                </label>
            </div>
        `);
        container.append(colDiv);
    });
    
    updateSelectedFieldsCount();
}

function updateSelectedFieldsCount() {
    const checkedCount = $('#fieldCheckboxes input:checked').length;
    const countBadge = $('#selectedFieldsCount');
    
    if (checkedCount === allColumns.length) {
        countBadge.text('全部字段').removeClass('bg-primary').addClass('bg-secondary');
    } else {
        countBadge.text(`${checkedCount}/${allColumns.length} 字段`).removeClass('bg-secondary').addClass('bg-primary');
    }
}

function loadData() {
    const params = new URLSearchParams({
        page: currentPage,
        per_page: perPage,
        fields: currentColumns.join(','),
        filters: JSON.stringify(filters)
    });
    
    fetch(`/api/project/${projectId}/data?${params}`)
        .then(response => response.json())
        .then(data => {
            renderTable(data.data);
            renderPagination(data.page, data.total_pages, data.total);
        })
        .catch(error => {
            console.error('Error loading data:', error);
        });
}

function renderTable(data) {
    const header = $('#tableHeader');
    const body = $('#tableBody');
    
    // 清空表格
    header.empty();
    body.empty();
    
    if (data.length === 0) {
        header.append('<th>序号</th>');
        body.append('<tr><td colspan="100%" class="text-center">暂无数据</td></tr>');
        return;
    }
    
    // 渲染表头
    header.append('<th>序号</th>');
    currentColumns.forEach(column => {
        header.append(`
            <th>
                ${column}
                <input type="text" class="form-control form-control-sm filter-input mt-1" 
                       placeholder="正则过滤" data-field="${column}"
                       value="${filters[column] || ''}">
            </th>
        `);
    });
    
    // 渲染数据行
    data.forEach((row, index) => {
        const tr = $('<tr></tr>');
        const globalIndex = (currentPage - 1) * perPage + index + 1;
        
        // 序号列
        tr.append(`
            <td>
                <a href="/project/${projectId}/record/${globalIndex - 1}" 
                   class="text-decoration-none">
                    ${globalIndex}
                </a>
            </td>
        `);
        
        // 数据列
        currentColumns.forEach(column => {
            let value = row[column] || '';
            let displayValue = value;
            
            // 长文本截断
            if (typeof value === 'string' && value.length > 100) {
                displayValue = value.substring(0, 100) + '[...长文本]';
                tr.attr('title', value);
            }
            
            // 创建单元格元素并设置内容
            const td = $('<td class="long-text"></td>');
            
            // 始终使用text()方法以原样显示内容，包括HTML标签
            td.text(displayValue);
            
            tr.append(td);
        });
        
        body.append(tr);
    });
    
    // 绑定过滤事件 - 使用防抖避免频繁请求
    let filterTimeout;
    $('.filter-input').on('input', function() {
        clearTimeout(filterTimeout);
        const field = $(this).data('field');
        const pattern = $(this).val();
        
        filterTimeout = setTimeout(() => {
            if (pattern) {
                filters[field] = pattern;
            } else {
                delete filters[field];
            }
            
            currentPage = 1;
            loadData();
        }, 500); // 500ms防抖
    });
}

function renderPagination(currentPage, totalPages, totalItems) {
    const pagination = $('#pagination');
    pagination.empty();
    
    if (totalPages <= 1) return;
    
    // 上一页
    const prevDisabled = currentPage === 1 ? 'disabled' : '';
    pagination.append(`
        <li class="page-item ${prevDisabled}">
            <a class="page-link" href="#" data-page="${currentPage - 1}">上一页</a>
        </li>
    `);
    
    // 页码
    const startPage = Math.max(1, currentPage - 2);
    const endPage = Math.min(totalPages, currentPage + 2);
    
    if (startPage > 1) {
        pagination.append('<li class="page-item"><a class="page-link" href="#" data-page="1">1</a></li>');
        if (startPage > 2) {
            pagination.append('<li class="page-item disabled"><span class="page-link">...</span></li>');
        }
    }
    
    for (let i = startPage; i <= endPage; i++) {
        const active = i === currentPage ? 'active' : '';
        pagination.append(`
            <li class="page-item ${active}">
                <a class="page-link" href="#" data-page="${i}">${i}</a>
            </li>
        `);
    }
    
    if (endPage < totalPages) {
        if (endPage < totalPages - 1) {
            pagination.append('<li class="page-item disabled"><span class="page-link">...</span></li>');
        }
        pagination.append(`<li class="page-item"><a class="page-link" href="#" data-page="${totalPages}">${totalPages}</a></li>`);
    }
    
    // 下一页
    const nextDisabled = currentPage === totalPages ? 'disabled' : '';
    pagination.append(`
        <li class="page-item ${nextDisabled}">
            <a class="page-link" href="#" data-page="${currentPage + 1}">下一页</a>
        </li>
    `);
}

// 绑定分页点击事件使用事件委托
$(document).on('click', '.page-link', function(e) {
    e.preventDefault();
    const page = parseInt($(this).data('page'));
    if (page && page !== currentPage) {
        currentPage = page;
        loadData();
    }
});

$(document).ready(function() {
    initializeFieldSelector();
    loadData();
    
    // 应用字段选择
    $('#applyFieldsBtn').on('click', function() {
        const selectedFields = [];
        $('#fieldCheckboxes input:checked').each(function() {
            selectedFields.push($(this).val());
        });
        
        currentColumns = selectedFields.length > 0 ? selectedFields : allColumns;
        updateSelectedFieldsCount();
        currentPage = 1;
        loadData();
        
        // 关闭模态框
        $('#fieldModal').modal('hide');
    });
    
    // 全选字段
    $('#selectAllFields').on('click', function() {
        $('#fieldCheckboxes input').prop('checked', true);
    });
    
    // 全不选字段
    $('#deselectAllFields').on('click', function() {
        $('#fieldCheckboxes input').prop('checked', false);
    });
    
    // 每页显示数量变化
    $('#perPageSelect').on('change', function() {
        perPage = parseInt($(this).val());
        currentPage = 1;
        loadData();
    });
});
</script>
{% endblock %}