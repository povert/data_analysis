{% extends "base.html" %}

{% block title %}记录详情 #{{ record_index + 1 }} - {{ project.filename }}{% endblock %}

{% block content %}
<div class="row mb-4">
    <div class="col-md-12">
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h3>
                    <i class="fas fa-file-alt"></i> 
                    {{ project.filename }} - 记录详情 #{{ record_index + 1 }}
                </h3>
                <div>
                    <a href="/project/{{ project.id }}" class="btn btn-secondary me-2">
                        <i class="fas fa-arrow-left"></i> 返回表格
                    </a>
                    <a href="/" class="btn btn-secondary">
                        <i class="fas fa-home"></i> 首页
                    </a>
                </div>
            </div>
            <div class="card-body">
                <p class="mb-2"><strong>数据集描述：</strong> {{ project.description }}</p>
                <small class="text-muted">文件类型：{{ project.file_type.upper() }} | 总记录数：{{ project.record_count }}</small>
            </div>
        </div>
    </div>
</div>
{% if record_index > 0 or record_index < project.record_count - 1 %}
<div class="row mb-3">
    {% if record_index > 0 %}
    <div class="col-md-6">
        <a href="/project/{{ project.id }}/record/{{ record_index - 1 }}{% if current_fields %}?fields={{ current_fields }}{% endif %}"
           class="btn btn-outline-secondary w-100">
            <i class="fas fa-chevron-left"></i> 上一条记录
        </a>
    </div>
    {% endif %}
    {% if record_index < project.record_count - 1 %}
    <div class="col-md-6">
        <a href="/project/{{ project.id }}/record/{{ record_index + 1 }}{% if current_fields %}?fields={{ current_fields }}{% endif %}"
           class="btn btn-outline-secondary w-100">
            下一条记录 <i class="fas fa-chevron-right"></i>
        </a>
    </div>
    {% endif %}
</div>
{% endif %}
<div class="row">
    <div class="col-md-3">
        <div class="card">
            <div class="card-header">
                <h5><i class="fas fa-filter"></i> 字段筛选</h5>
            </div>
            <div class="card-body">
                <div class="mb-3">
                    <button id="selectAll" class="btn btn-sm btn-outline-primary me-2">全选</button>
                    <button id="deselectAll" class="btn btn-sm btn-outline-secondary">全不选</button>
                </div>
                <div class="form-check-list">
                    {% for field in all_fields %}
                    <div class="form-check">
                        <input class="form-check-input field-checkbox" type="checkbox" 
                               value="{{ field }}" id="field_{{ field }}"
                               {% if field in selected_fields %}checked{% endif %}>
                        <label class="form-check-label" for="field_{{ field }}">
                            {{ field }}
                        </label>
                    </div>
                    {% endfor %}
                </div>
                <div class="mt-3">
                    <button id="applyFilter" class="btn btn-primary btn-sm">应用筛选</button>
                </div>
            </div>
        </div>
    </div>
    <div class="col-md-9">
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h4><i class="fas fa-info-circle"></i> 字段详情</h4>
                <span class="badge bg-info">显示 {{ selected_fields|length }} / {{ all_fields|length }} 个字段</span>
            </div>
            <div class="card-body">
                {% for key, value in record.items() %}
                <div class="record-detail" data-field="{{ key }}">
                    <div class="row">
                        <div class="col-md-3">
                            <strong>{{ key }}:</strong>
                        </div>
                        <div class="col-md-9">
                            {% if value is string and (value.startswith('{') or value.startswith('[')) %}
                                <div class="json-value">{{ value }}</div>
                            {% else %}
                                <div class="field-value">{{ value }}</div>
                            {% endif %}
                        </div>
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block scripts %}
<script>
// HTML转义函数
function escapeHtml(text) {
    if (typeof text !== 'string') {
        return text;
    }
    const map = {
        '&': '&amp;',
        '<': '&lt;',
        '>': '&gt;',
        '"': '&quot;',
        "'": '&#039;'
    };
    return text.replace(/[&<>"']/g, function(m) { return map[m]; });
}

// HTML反转义函数
function unEscapeHtml(text) {
    if (typeof text !== 'string') {
        return text;
    }
    const map = {
        '&amp;': '&',
        '&lt;': '<',
        '&gt;': '>',
        '&quot;': '"',
        '&#039;': "'",
        '&apos;': "'"
    };
    return text.replace(/&(amp|lt|gt|quot|#039|apos);/g, function(m) { return map[m]; });
}

// 安全的HTML sanitizer，只允许安全的HTML标签
function sanitizeHtml(html) {
    // 检查内容是否包含HTML标签
    if (!html || typeof html !== 'string' || !html.includes('<') || !html.includes('>')) {
        return html;
    }
    
    // 使用DOMParser来解析HTML，确保安全性
    const parser = new DOMParser();
    const doc = parser.parseFromString(html, 'text/html');
    
    // 只允许安全的标签
    const allowedTags = ['b', 'i', 'em', 'strong', 'p', 'br', 'h1', 'h2', 'h3', 'h4', 'h5', 'h6', 'ul', 'ol', 'li', 'span', 'div', 'small', 'code', 'pre'];
    
    // 递归处理DOM节点，移除不安全的标签
    function sanitizeNode(node) {
        if (node.nodeType === Node.TEXT_NODE) {
            return document.createTextNode(node.textContent);
        } else if (node.nodeType === Node.ELEMENT_NODE) {
            if (allowedTags.includes(node.tagName.toLowerCase())) {
                const newNode = document.createElement(node.tagName);
                // 只允许安全的属性
                for (let attr of node.attributes) {
                    if (['class', 'style', 'id'].includes(attr.name.toLowerCase())) {
                        // 确保style属性不包含危险内容
                        if (attr.name.toLowerCase() === 'style') {
                            const styleValue = attr.value.toLowerCase();
                            if (!['javascript:', 'vbscript:', 'script:', 'url('].some(x => styleValue.includes(x))) {
                                newNode.setAttribute(attr.name, attr.value);
                            }
                        } else {
                            newNode.setAttribute(attr.name, attr.value);
                        }
                    }
                }
                for (let child of node.childNodes) {
                    newNode.appendChild(sanitizeNode(child));
                }
                return newNode;
            } else {
                // 如果标签不安全，则提取其内容
                const fragment = document.createDocumentFragment();
                for (let child of node.childNodes) {
                    fragment.appendChild(sanitizeNode(child));
                }
                return fragment;
            }
        }
        return document.createDocumentFragment();
    }
    
    // 处理文档的所有子节点
    const sanitized = document.createDocumentFragment();
    for (let child of doc.body.childNodes) {
        sanitized.appendChild(sanitizeNode(child));
    }
    
    // 创建一个临时容器来获取HTML字符串
    const tempDiv = document.createElement('div');
    tempDiv.appendChild(sanitized);
    return tempDiv.innerHTML;
}

$(document).ready(function() {
    // 为JSON值添加语法高亮
    $('.json-value').each(function() {
        try {
            const jsonText = $(this).text();
            const parsed = JSON.parse(jsonText);
            $(this).html(syntaxHighlight(JSON.stringify(parsed, null, 2)));
        } catch (e) {
            // 如果解析失败，保持原样
        }
    });
    
    // 全选功能
    $('#selectAll').click(function() {
        $('.field-checkbox').prop('checked', true);
    });
    
    // 全不选功能
    $('#deselectAll').click(function() {
        $('.field-checkbox').prop('checked', false);
    });
    
    // 应用筛选功能
    $('#applyFilter').click(function() {
        const selectedFields = [];
        $('.field-checkbox:checked').each(function() {
            selectedFields.push($(this).val());
        });
        
        // 构建新的URL
        const url = new URL(window.location);
        if (selectedFields.length > 0) {
            url.searchParams.set('fields', selectedFields.join(','));
        } else {
            url.searchParams.delete('fields');
        }
        
        // 重定向到新的URL
        window.location.href = url.toString();
    });
    
    // 实时预览字段显示/隐藏效果
    $('.field-checkbox').change(function() {
        const fieldName = $(this).val();
        const isChecked = $(this).is(':checked');
        
        if (isChecked) {
            $(`.record-detail[data-field="${fieldName}"]`).show();
        } else {
            $(`.record-detail[data-field="${fieldName}"]`).hide();
        }
        
        // 更新字段计数
        const visibleCount = $('.record-detail:visible').length;
        const totalCount = $('.record-detail').length;
        $('.badge').text(`显示 ${visibleCount} / ${totalCount} 个字段`);
    });
});

function syntaxHighlight(json) {
    json = json.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;');
    return json.replace(/("(\\u[a-zA-Z0-9]{4}|\\[^u]|[^\\"])*"(\s*:)?|\b(true|false|null)\b|-?\d+(?:\.\d*)?(?:[eE][+\-]?\d+)?)/g, function (match) {
        let cls = 'number';
        if (/^"/.test(match)) {
            if (/:$/.test(match)) {
                cls = 'key';
            } else {
                cls = 'string';
            }
        } else if (/true|false/.test(match)) {
            cls = 'boolean';
        } else if (/null/.test(match)) {
            cls = 'null';
        }
        return '<span class="' + cls + '">' + match + '</span>';
    });
}
</script>

<style>
.string { color: #0451a5; }
.number { color: #098658; }
.boolean { color: #0000ff; }
.null { color: #808080; }
.key { color: #0000ff; font-weight: bold; }

/* 字段选择器样式 */
.form-check-list {
    max-height: 300px;
    overflow-y: auto;
    border: 1px solid #dee2e6;
    border-radius: 0.25rem;
    padding: 0.5rem;
}

.form-check {
    margin-bottom: 0.25rem;
}

.form-check-input:checked {
    background-color: #0d6efd;
    border-color: #0d6efd;
}

.record-detail {
    padding: 0.75rem 0;
    border-bottom: 1px solid #f8f9fa;
    transition: all 0.2s ease;
}

.record-detail:last-child {
    border-bottom: none;
}

.record-detail:hover {
    background-color: #f8f9fa;
    border-radius: 0.25rem;
    margin: 0 -0.75rem;
    padding: 0.75rem;
}

/* 使字段值支持换行 */
.field-value {
    white-space: pre-wrap; /* 保留空白符和换行符 */
    word-wrap: break-word; /* 长内容自动换行 */
}

/* 响应式调整 */
@media (max-width: 768px) {
    .form-check-list {
        max-height: 200px;
    }
}
</style>
{% endblock %}