{% extends "base.html" %}

{% block title %}上传数据 - 数据文件管理系统{% endblock %}

{% block content %}
<div class="row justify-content-center">
    <div class="col-md-8">
        <div class="card">
            <div class="card-header">
                <h3><i class="fas fa-upload"></i> 上传数据文件</h3>
            </div>
            <div class="card-body">
                <form id="uploadForm" enctype="multipart/form-data">
                    <div class="mb-3">
                        <label for="file" class="form-label">选择文件</label>
                        <input type="file" class="form-control" id="file" name="file" required
                               accept=".csv,.json,.jsonl">
                        <div class="form-text">
                            支持的文件格式：CSV、JSON、JSONL
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <label for="description" class="form-label">数据描述</label>
                        <textarea class="form-control" id="description" name="description" 
                                  rows="3" required placeholder="请描述这个数据集的内容和用途..."></textarea>
                    </div>
                    
                    <div class="d-grid gap-2">
                        <button type="submit" class="btn btn-primary">
                            <i class="fas fa-cloud-upload-alt"></i> 上传文件
                        </button>
                    </div>
                </form>
                
                <div id="uploadResult" class="mt-3"></div>
            </div>
        </div>
        
        <div class="card mt-4">
            <div class="card-header">
                <h4><i class="fas fa-info-circle"></i> 文件格式说明</h4>
            </div>
            <div class="card-body">
                <div class="accordion" id="formatAccordion">
                    <div class="accordion-item">
                        <h2 class="accordion-header">
                            <button class="accordion-button" type="button" data-bs-toggle="collapse" 
                                    data-bs-target="#csvFormat">
                                CSV 格式
                            </button>
                        </h2>
                        <div id="csvFormat" class="accordion-collapse collapse show" 
                             data-bs-parent="#formatAccordion">
                            <div class="accordion-body">
                                <p>标准的CSV文件，第一行为表头：</p>
                                <pre>name,age,city
张三,25,北京
李四,30,上海</pre>
                            </div>
                        </div>
                    </div>
                    
                    <div class="accordion-item">
                        <h2 class="accordion-header">
                            <button class="accordion-button collapsed" type="button" 
                                    data-bs-toggle="collapse" data-bs-target="#jsonlFormat">
                                JSONL 格式
                            </button>
                        </h2>
                        <div id="jsonlFormat" class="accordion-collapse collapse" 
                             data-bs-parent="#formatAccordion">
                            <div class="accordion-body">
                                <p>每行一个JSON对象：</p>
                                <pre>{"name": "张三", "age": 25, "city": "北京"}
{"name": "李四", "age": 30, "city": "上海"}</pre>
                            </div>
                        </div>
                    </div>
                    
                    <div class="accordion-item">
                        <h2 class="accordion-header">
                            <button class="accordion-button collapsed" type="button" 
                                    data-bs-toggle="collapse" data-bs-target="#jsonFormat">
                                JSON 格式
                            </button>
                        </h2>
                        <div id="jsonFormat" class="accordion-collapse collapse" 
                             data-bs-parent="#formatAccordion">
                            <div class="accordion-body">
                                <p>支持两种JSON格式：</p>
                                
                                <p><strong>1. 行式格式（推荐）：</strong></p>
                                <pre>{
  "data": [
    {"name": "张三", "age": 25, "city": "北京"},
    {"name": "李四", "age": 30, "city": "上海"}
  ]
}</pre>
                                
                                <p><strong>2. 列式格式：</strong></p>
                                <pre>{
  "name": ["张三", "李四"],
  "age": [25, 30],
  "city": ["北京", "上海"]
}</pre>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
$(document).ready(function() {
    $('#uploadForm').on('submit', async function(e) {
        e.preventDefault();
        
        const formData = new FormData();
        formData.append('file', $('#file')[0].files[0]);
        formData.append('description', $('#description').val());
        
        try {
            const response = await fetch('/api/upload', {
                method: 'POST',
                body: formData
            });
            
            const result = await response.json();
            
            if (response.ok) {
                $('#uploadResult').html(`
                    <div class="alert alert-success">
                        <i class="fas fa-check-circle"></i> 文件上传成功！
                        <a href="/project/${result.project_id}" class="btn btn-sm btn-primary ms-2">
                            查看数据
                        </a>
                    </div>
                `);
                
                // 清空表单
                $('#uploadForm')[0].reset();
            } else {
                $('#uploadResult').html(`
                    <div class="alert alert-danger">
                        <i class="fas fa-exclamation-circle"></i> 上传失败：${result.detail}
                    </div>
                `);
            }
        } catch (error) {
            $('#uploadResult').html(`
                <div class="alert alert-danger">
                    <i class="fas fa-exclamation-circle"></i> 上传失败：网络错误
                </div>
            `);
        }
    });
});
</script>
{% endblock %}